{{ define "main" }}

<!-- Tag Title -->
{{- if and .Title (eq .Type "tags") -}}
<h2 class="" style="margin-bottom: auto !important; margin-top: 1em;">#{{- .Title -}}</h2>
{{- end -}}

<!-- Define $pages -->
{{ $pages := union .RegularPages .Sections }}
{{ if .IsHome }}
{{ $pages = where site.RegularPages "Type" "in" .Site.Params.mainSections }}
</pre>
{{ end }}

<!-- Define $paginator -->
{{ $paginator := .Paginate $pages }}

<!-- Featured Section (Displayed on Home Page, First Page Only) -->
{{ if and $.IsHome (eq $paginator.PageNumber 1) }}
<div class="featured-container w-full mb-16">

  <!-- Random GIF Banner -->
  {{ $isMobile := `@media (max-width: 768px) { #landscape { display: none; } #portrait { display: block; } }
  @media (min-width: 769px) { #landscape { display: block; } #portrait { display: none; } }` }}

  <link rel="stylesheet" href="data:text/css;base64,{{ $isMobile | base64Encode }}" media="screen">


  {{ $portraitDir := "/animation/golden-portrait/" }}
  {{ $landscapeDir := "/animation/golden-landscape/" }}
  {{ $portraitFiles := readDir (printf "static%s" $portraitDir) }}
  {{ $landscapeFiles := readDir (printf "static%s" $landscapeDir) }}


  {{ $portraitAssets := slice }}
  {{ range $portraitFiles }}
  {{ if not .IsDir }}
  {{ $portraitAssets = $portraitAssets | append .Name }}
  {{ end }}
  {{ end }}

  {{ $landscapeAssets := slice }}
  {{ range $landscapeFiles }}
  {{ if not .IsDir }}
  {{ $landscapeAssets = $landscapeAssets | append .Name }}
  {{ end }}
  {{ end }}

  {{ warnf "Portrait Assets: %s" $portraitAssets }}
  {{ warnf "Landscape Assets: %s" $landscapeAssets }}


  {{ if and (gt (len $portraitAssets) 0) (gt (len $landscapeAssets) 0) }}
  {{ $initialPortraitAsset := index ($portraitAssets | shuffle) 0 }}
  {{ $initialLandscapeAsset := index ($landscapeAssets | shuffle) 0 }}

  <div id="portrait" data-assets='{{ $portraitAssets | jsonify }}' data-path="{{ $portraitDir }}">
    {{ if or (strings.HasSuffix $initialPortraitAsset ".webm") (strings.HasSuffix $initialPortraitAsset ".mp4") }}
    <video autoplay loop muted playsinline src="{{ $portraitDir }}{{ $initialPortraitAsset }}" class="banner-media"
      id="random-portrait-media" style="width: 100%; height: auto;"></video>
    {{ else }}
    <img src="{{ $portraitDir }}{{ $initialPortraitAsset }}" alt="Banner" class="banner-media"
      id="random-portrait-media" style="width: 100%; height: auto;">
    {{ end }}
  </div>
  <div id="landscape" data-assets='{{ $landscapeAssets | jsonify }}' data-path="{{ $landscapeDir }}">
    {{ if or (strings.HasSuffix $initialLandscapeAsset ".webm") (strings.HasSuffix $initialLandscapeAsset ".mp4") }}
    <video autoplay loop muted playsinline src="{{ $landscapeDir }}{{ $initialLandscapeAsset }}" class="banner-media"
      id="random-landscape-media" style="width: 100%; height: auto;"></video>
    {{ else }}
    <img src="{{ $landscapeDir }}{{ $initialLandscapeAsset }}" alt="Banner" class="banner-media"
      id="random-landscape-media" style="width: 100%; height: auto;">
    {{ end }}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function isVideo(filename) {
        return filename.endsWith('.webm') || filename.endsWith('.mp4');
      }

      function createMediaElement(filename, path, id) {
        const fullSrc = path + filename;
        let newElement;
        if (isVideo(filename)) {
          newElement = document.createElement('video');
          newElement.autoplay = true;
          newElement.loop = true;
          newElement.muted = true;
          newElement.playsInline = true;
        } else {
          newElement = document.createElement('img');
          newElement.alt = "Banner";
        }
        newElement.src = fullSrc;
        newElement.className = "banner-media";
        newElement.id = id;
        newElement.style.width = "100%";
        newElement.style.height = "auto";
        return newElement;
      }

      function updateMedia() {
        const isDarkMode = document.documentElement.classList.contains('dark');

        ['portrait', 'landscape'].forEach(type => {
          const container = document.getElementById(type);
          if (!container) return;

          const currentMedia = document.getElementById(`random-${type}-media`);
          const assets = JSON.parse(container.dataset.assets);
          const path = container.dataset.path;

          // Filter logic
          let filteredAssets = assets.filter(asset => {
            if (asset.includes('-dark') && !isDarkMode) return false;
            if (asset.includes('-bright') && isDarkMode) return false;
            return true;
          });

          if (filteredAssets.length === 0) filteredAssets = assets;
          const randomAsset = filteredAssets[Math.floor(Math.random() * filteredAssets.length)];

          // Check if we need to swap the element type
          const currentIsVideo = currentMedia.tagName === 'VIDEO';
          const newIsVideo = isVideo(randomAsset);

          if (currentIsVideo !== newIsVideo) {
            // Type mismatch, replace element
            const newElement = createMediaElement(randomAsset, path, `random-${type}-media`);
            container.replaceChild(newElement, currentMedia);
          } else {
            // Same type, just update src if different
            const newSrc = window.location.origin + path + randomAsset; // Helper for comparison, although src property is absolute usually
            // But simpler: just set it.
            if (!currentMedia.src.endsWith(randomAsset)) {
              currentMedia.src = path + randomAsset;
            }
          }
        });
      }

      // Run once when DOM is loaded.
      updateMedia();

      // Re-run updateMedia() when dark mode changes.
      const observer = new MutationObserver(() => {
        updateMedia();
      });
      observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    });
  </script>
  {{ end }}

  <p>Welcome to my world wide web. Let's start with some <a href='/music'>music</a> and <a href='/blog'>blogs</a>?</p>

  {{ range .Site.Params.aboutItems }}
  <div class="about-item">
    <p class="about-text"><b>{{ .title | safeHTML }}</b> {{ .description | safeHTML }}</p>
  </div>
  {{ end }}
</div>

<div class="section-divider w-full border-t border-gray-200 dark:border-gray-700 my-8"></div>
{{ end }}


<!-- List of Posts in Grid Layout -->
<div class="list-posts w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8">
  {{ range $paginator.Pages }}
  <section class="relative my-10 first-of-type:mt-0 last-of-type:mb-0">
    {{ if gt .Weight 0 }}
    <span class="mb-1 inline-block text-xs tracking-wider text-orange-500">Featured</span>
    {{ end }}
    <h2 class="!my-0">{{ .Title }}</h2>
    <time class="text-xs antialiased opacity-60">{{ .Date | time.Format ":date_medium" }}</time>
    <a class="absolute inset-0 text-[0]" href="{{ .Permalink }}">{{ .Title }}</a>
  </section>
  {{ end }}
</div>

<!-- Pagination Navigation -->
{{ if gt $paginator.TotalPages 1 }}
<nav class="mt-14 flex">
  {{ if $paginator.HasPrev }}
  <a class="btn" href="{{ $paginator.Prev.URL }}">← {{ i18n "prev_page" }}</a>
  {{ end }}
  {{ if $paginator.HasNext }}
  <a class="btn ml-auto" href="{{ $paginator.Next.URL }}">{{ i18n "next_page" }} →</a>
  {{ end }}
</nav>
{{ end }}

{{ end }}